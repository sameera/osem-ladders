name: Deploy Cognito Post-Signup Lambda

on:
    push:
        branches:
            - main
        paths:
            - "backend/cognito-post-signup/**"
    workflow_dispatch: # Allow manual trigger

env:
    AWS_REGION: us-east-2 # Update to your AWS region
    LAMBDA_FUNCTION_NAME: osem-ladders-cognito-post-signup # Update to your Lambda function name
    NODE_VERSION: "18"

jobs:
    deploy:
        name: Build and Deploy Lambda
        runs-on: ubuntu-latest

        permissions:
            id-token: write # Required for AWS OIDC
            contents: read

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Setup pnpm
              uses: pnpm/action-setup@v3
              with:
                  version: 8

            - name: Install dependencies
              run: pnpm install --frozen-lockfile --filter=./backend/cognito-post-signup

            - name: Run tests
              working-directory: backend/cognito-post-signup
              run: pnpm test

            - name: Build Lambda function
              working-directory: backend/cognito-post-signup
              run: pnpm build

            - name: Package Lambda function
              working-directory: backend/cognito-post-signup
              run: |
                  cd dist
                  zip -r ../function.zip .
                  cd ..
                  # Include node_modules for dependencies
                  zip -r function.zip node_modules -x "node_modules/@types/*" -x "node_modules/typescript/*" -x "node_modules/vitest/*" -x "node_modules/@vitest/*" -x "node_modules/eslint/*" -x "node_modules/@typescript-eslint/*"

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
                  aws-region: ${{ env.AWS_REGION }}

            - name: Deploy to AWS Lambda
              working-directory: backend/cognito-post-signup
              run: |
                  aws lambda update-function-code \
                    --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
                    --zip-file fileb://function.zip \
                    --region ${{ env.AWS_REGION }}

            - name: Wait for Lambda update to complete
              run: |
                  aws lambda wait function-updated \
                    --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
                    --region ${{ env.AWS_REGION }}

            - name: Verify deployment
              run: |
                  aws lambda get-function \
                    --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
                    --region ${{ env.AWS_REGION }} \
                    --query 'Configuration.[FunctionName,LastModified,State]' \
                    --output table
